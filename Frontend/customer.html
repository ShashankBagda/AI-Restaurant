<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Restaurant Customer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 24px;
        background: #f5f5f5;
        color: #222;
      }
      .card {
        background: #fff;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 16px;
      }
      input, button {
        padding: 8px;
        margin: 6px 0;
      }
      button {
        cursor: pointer;
      }
      .menu-item {
        padding: 6px 0;
        border-bottom: 1px solid #eee;
      }
      .menu-item:last-child {
        border-bottom: none;
      }
      .pill {
        background: #222;
        color: #fff;
        border-radius: 16px;
        padding: 6px 12px;
        display: inline-block;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Customer Login</h2>
      <div id="serverStatus" class="pill">Waiting for server</div>
      <div>
        <label>Device ID</label>
        <input id="deviceId" type="text" value="table-01" />
      </div>
      <div>
        <label>Table ID</label>
        <input id="tableId" type="text" value="T1" />
      </div>
      <div>
        <label>User ID</label>
        <input id="userId" type="text" placeholder="demo" />
      </div>
      <div>
        <label>Password</label>
        <input id="password" type="password" placeholder="demo123" />
      </div>
      <button id="loginBtn">Login</button>
      <button id="registerBtn">Register</button>
      <div id="status" class="pill">Not logged in</div>
    </div>

    <div class="card">
      <h2>Menu</h2>
      <button id="menuBtn">Load Menu</button>
      <div id="menu"></div>
    </div>

    <script>
      const statusEl = document.getElementById("status");
      const menuEl = document.getElementById("menu");
      const serverStatusEl = document.getElementById("serverStatus");
      const deviceIdEl = document.getElementById("deviceId");
      const tableIdEl = document.getElementById("tableId");
      const userIdEl = document.getElementById("userId");
      const passwordEl = document.getElementById("password");
      const loginBtn = document.getElementById("loginBtn");
      const registerBtn = document.getElementById("registerBtn");
      const menuBtn = document.getElementById("menuBtn");

      let token = "";
      let serverUrl = "";

      function applyServerFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const server = params.get("server");
        if (server) {
          serverUrl = server;
          serverStatusEl.textContent = `Connected to ${serverUrl}`;
        } else {
          serverUrl = "http://127.0.0.1:8000";
          serverStatusEl.textContent = `Connected to ${serverUrl}`;
        }
      }

      async function sendPing() {
        const payload = {
          device_id: deviceIdEl.value.trim(),
          table_id: tableIdEl.value.trim(),
        };
        if (!serverUrl || !payload.device_id || !payload.table_id) return;
        try {
          await fetch(`${serverUrl}/api/client/ping`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        } catch (err) {
          // ignore ping failures
        }
      }

      async function login() {
        if (!serverUrl) {
          statusEl.textContent = "Missing server URL";
          return;
        }
        statusEl.textContent = "Logging in...";
        try {
          const res = await fetch(`${serverUrl}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              device_id: deviceIdEl.value.trim(),
              user_id: userIdEl.value.trim(),
              password: passwordEl.value,
              table_id: tableIdEl.value.trim(),
            }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "Login failed");
          token = data.token;
          statusEl.textContent = data.welcome;
        } catch (err) {
          statusEl.textContent = err.message;
        }
      }

      async function register() {
        if (!serverUrl) {
          statusEl.textContent = "Missing server URL";
          return;
        }
        statusEl.textContent = "Registering...";
        try {
          const res = await fetch(`${serverUrl}/api/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: userIdEl.value.trim(),
              password: passwordEl.value,
              role: "customer",
            }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "Registration failed");
          statusEl.textContent = `Registered ${data.user_id}`;
        } catch (err) {
          statusEl.textContent = err.message;
        }
      }

      async function loadMenu() {
        if (!serverUrl) {
          statusEl.textContent = "Missing server URL";
          return;
        }
        if (!token) {
          statusEl.textContent = "Login required before loading menu";
          return;
        }
        statusEl.textContent = "Loading menu...";
        try {
          const res = await fetch(`${serverUrl}/api/menu?token=${token}`);
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "Menu load failed");
          menuEl.innerHTML = "";
          data.items.forEach((item) => {
            const row = document.createElement("div");
            row.className = "menu-item";
            row.innerHTML = `<strong>${item.name}</strong> - $${item.price.toFixed(2)}<div>${item.tags.join(", ")}</div>`;
            menuEl.appendChild(row);
          });
          statusEl.textContent = "Menu loaded";
        } catch (err) {
          statusEl.textContent = err.message;
        }
      }

      loginBtn.addEventListener("click", login);
      registerBtn.addEventListener("click", register);
      menuBtn.addEventListener("click", loadMenu);
      setInterval(sendPing, 10000);
      applyServerFromQuery();
    </script>
  </body>
</html>
